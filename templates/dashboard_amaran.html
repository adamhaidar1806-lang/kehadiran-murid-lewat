{% extends "base.html" %}

{% block title %}Dashboard Amaran - Sistem Kehadiran Lewat{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard_overview') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Amaran</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="mb-0">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>Dashboard Amaran
        </h2>
        <div class="d-flex gap-2 align-items-center">
            <form class="d-flex gap-2" method="GET">
                <select name="month" class="form-select form-select-sm" style="width: auto;">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == month %}selected{% endif %}>
                        {{ ['', 'Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'][m] }}
                    </option>
                    {% endfor %}
                </select>
                <select name="year" class="form-select form-select-sm" style="width: auto;">
                    {% for y in range(2024, 2030) %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-primary-custom">
                    <i class="fas fa-filter me-1"></i>Tapis
                </button>
            </form>
        </div>
    </div>
    
    {% if warnings %}
    <div class="alert alert-warning fade-in-up">
        <i class="fas fa-info-circle me-2"></i>
        <strong>{{ warnings|length }}</strong> murid telah lewat 3 kali atau lebih pada bulan ini dan memerlukan tindakan.
    </div>
    
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-custom mb-0">
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" class="form-check-input checkbox-custom" onclick="toggleSelectAll(this)">
                            </th>
                            <th>Nama Murid</th>
                            <th>IC</th>
                            <th>Kelas</th>
                            <th>Jantina</th>
                            <th>Kali Lewat</th>
                            <th>Tarikh Lewat</th>
                            <th width="200">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in warnings %}
                        <tr class="fade-in-up" style="animation-delay: {{ loop.index * 0.05 }}s;">
                            <td>
                                <input type="checkbox" class="form-check-input checkbox-custom row-checkbox" 
                                       value="{{ item.murid.id }}" onchange="updateBulkActions()">
                            </td>
                            <td>
                                <strong>{{ item.murid.nama_penuh }}</strong>
                                {% if item.murid.is_bookmarked %}
                                <i class="fas fa-star text-warning ms-1" title="Ditanda"></i>
                                {% endif %}
                            </td>
                            <td>{{ item.murid.ic }}</td>
                            <td>{{ item.murid.kelas.nama_kelas }}</td>
                            <td>
                                <span class="badge {% if item.murid.jantina == 'Lelaki' %}bg-primary{% else %}bg-danger{% endif %}">
                                    {{ item.murid.jantina }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-danger-custom">{{ item.count }} kali</span>
                            </td>
                            <td>
                                {% for k in item.kehadiran[:5] %}
                                <small class="d-block">
                                    {{ k.tarikh.strftime('%d/%m/%Y') }} - {{ k.masa_sampai.strftime('%H:%M') }}
                                    {% if k.minit_lewat %}({{ k.minit_lewat }} min){% endif %}
                                </small>
                                {% endfor %}
                                {% if item.kehadiran|length > 5 %}
                                <small class="text-muted">+{{ item.kehadiran|length - 5 }} lagi...</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-1 flex-wrap">
                                    <a href="{{ url_for('generate_surat', murid_id=item.murid.id, month=month, year=year) }}" 
                                       class="action-btn print" title="Print Surat Amaran" data-bs-toggle="tooltip">
                                        <i class="fas fa-print"></i>
                                    </a>
                                    <button type="button" class="action-btn view" title="Tambah Denda" data-bs-toggle="modal" 
                                            data-bs-target="#dendaModal" data-murid-id="{{ item.murid.id }}" 
                                            data-murid-nama="{{ item.murid.nama_penuh }}">
                                        <i class="fas fa-gavel"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="bulk-actions" class="position-fixed bottom-0 start-50 translate-middle-x mb-4 bg-dark text-white p-3 rounded-pill shadow-lg" style="display: none; z-index: 1000;">
        <span class="me-3"><span id="selected-count">0</span> dipilih</span>
        <button class="btn btn-sm btn-success me-2" onclick="bulkPrint()">
            <i class="fas fa-print me-1"></i>Print Semua
        </button>
        <button class="btn btn-sm btn-outline-light" onclick="clearSelection()">Batal</button>
    </div>
    
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <div class="fade-in-up">
                <i class="fas fa-check-circle text-success fa-5x mb-4"></i>
                <h3 class="text-muted mb-3">Tahniah!</h3>
                <p class="text-muted">
                    Tiada murid yang lewat 3 kali atau lebih pada 
                    <strong>{{ ['', 'Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'][month] }} {{ year }}</strong>.
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="dendaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-gavel me-2"></i>Tambah Denda
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="dendaForm" method="POST">
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        Denda untuk: <strong id="dendaMuridNama"></strong>
                    </p>
                    <div class="mb-3">
                        <label class="form-label">Jenis Denda/Tindakan</label>
                        <textarea name="jenis_denda" class="form-control" rows="3" 
                                  placeholder="Contoh: Kutip sampah di kawasan kantin selama 3 hari" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nota Tambahan (Pilihan)</label>
                        <textarea name="nota" class="form-control" rows="2" 
                                  placeholder="Sebarang catatan tambahan..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save me-1"></i>Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dendaModal = document.getElementById('dendaModal');
    dendaModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const muridId = button.getAttribute('data-murid-id');
        const muridNama = button.getAttribute('data-murid-nama');
        
        document.getElementById('dendaMuridNama').textContent = muridNama;
        document.getElementById('dendaForm').action = '/dashboard/denda/' + muridId;
    });
});

function bulkPrint() {
    const selected = getSelectedIds();
    if (selected.length === 0) return;
    
    Swal.fire({
        title: 'Print Surat Amaran',
        text: `Akan print surat untuk ${selected.length} murid. Teruskan?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Ya, Print',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            selected.forEach((id, index) => {
                setTimeout(() => {
                    window.open(`/generate-surat/${id}?month={{ month }}&year={{ year }}`, '_blank');
                }, index * 500);
            });
        }
    });
}

function clearSelection() {
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
    document.querySelector('thead input[type="checkbox"]').checked = false;
    updateBulkActions();
}

function toggleSelectAll(source) {
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = source.checked);
    updateBulkActions();
}

function updateBulkActions() {
    const checked = document.querySelectorAll('.row-checkbox:checked').length;
    const bulkActions = document.getElementById('bulk-actions');
    document.getElementById('selected-count').textContent = checked;
    bulkActions.style.display = checked > 0 ? 'block' : 'none';
}

function getSelectedIds() {
    return Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
}
</script>
{% endblock %}
